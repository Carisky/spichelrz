{{header}}

<div class="single-product">

	<div class="left">
		{% if breadcrumbs %}
			<div class="breadcrumbs">
				{% for breadcrumb in breadcrumbs %}
					<div>
						{% if loop.last %}
							<div class="last">
								<span class="last">{{ breadcrumb.text }}</span>
							</div>
						{% else %}
							<a class="link" href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a>
							<span>/</span>
						{% endif %}
					</div>
				{% endfor %}
			</div>
		{% endif %}
		<img class="product-image" src="{{ image_url }}" alt="{{ name }}" onerror="this.onerror=null; this.src='image/no_image.png';"/>
	</div>
	<div class="right">
		<div class="product-name">
			{{name}}
		</div>
		<div class="rating">
			{{ stars|raw }}
		</div>
		<div class="warehouse-info">
			<div class="block">
				<img src="image/catalog/assets/on_stock_ico.svg"/>&nbsp;
				<span>{{quantity}}&nbsp;</span>
				<span>w magazynie</span>
			</div>
			<div class="block">
				<img src="image/catalog/assets/shipment_ico.svg"/>&nbsp;
				<span>Termin wysyłki&nbsp;</span>
				<span>2 dni robocze</span>
			</div>
		</div>
		<div class="description">
			{{raw}}
		</div>
		<div class="additional-info">
			<div>
				<span class="bold">Brand :</span>
				<span class="common">Spichlerz</span>
			</div>
			<div>
				<span class="bold">SKU :</span>
				<span class="common">{{sku}}</span>
			</div>
			<div>
				<span class="bold">Category :</span>
				<span class="common">{{category}}</span>
			</div>

			{% if old_price_numeric > price_numeric %}
				<div class="price ">
					<div class="old-price">{{ old_price }}</div>
					<div class="current">{{ price }}</div>
				</div>
			{% else %}
				<div class="price">
					<div class="current">{{ price }}</div>
				</div>
			{% endif %}

		</div>
		<div class="actions">
			<div class="count">
				<div class="event" id="minus">-</div>
				<div id="value">1</div>
				<div class="event" id="add">+</div>
			</div>
			<div id="addToCartBtn" class="to-cart" onclick="addToCart({{id}})" data-product-id={{id}}>
				<p>DO KOSZYKA</p>
				<img src="image/catalog/assets/add_to_cart_ico.svg"/>
			</div>
		</div>
	</div>

</div>
<div class="accordion">
	<div class="accordion-item">
		<button class="accordion-header">Opis produktu</button>
		<div class="accordion-content">
			{{ description }}
		</div>
	</div>
	<div class="accordion-item">
		<button class="accordion-header">Opinie</button>
		<div class="accordion-content">
			<p>Przeczytaj opinie innych użytkowników o tym produkcie.</p>
			<div id="reviews"></div>
		</div>
	</div>
	<div class="accordion-item">
		<button class="accordion-header">Dodaj opinię</button>
		<div class="accordion-content">
			<div id="review-message"></div>
			<form id="review-form" action="{{ review_action }}" method="post" class="opinion-form">
				<input type="hidden" name="product_id" value="{{ id }}"/>
				<div class="form-control">
					<label for="rating">Twoja ocena *</label>
					<div class="rating-stars">
						<input type="radio" id="star5" name="rating" value="5">
						<label for="star5" title="5 stars">
							<svg width="13" height="12" viewbox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M6.5 0.618034L7.59607 3.99139C7.72994 4.40341 8.1139 4.68237 8.54713 4.68237H12.0941L9.22453 6.76722C8.87405 7.02186 8.72739 7.47323 8.86126 7.88526L9.95733 11.2586L7.08779 9.17376C6.7373 8.91912 6.2627 8.91912 5.91221 9.17376L3.04267 11.2586L4.13874 7.88525C4.27261 7.47323 4.12595 7.02186 3.77547 6.76722L0.905918 4.68237H4.45287C4.8861 4.68237 5.27006 4.40341 5.40393 3.99139L6.5 0.618034Z" stroke="#C7A992"/>
							</svg>
						</label>
						<input type="radio" id="star4" name="rating" value="4">
						<label for="star4" title="4 stars">
							<svg width="13" height="12" viewbox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M6.5 0.618034L7.59607 3.99139C7.72994 4.40341 8.1139 4.68237 8.54713 4.68237H12.0941L9.22453 6.76722C8.87405 7.02186 8.72739 7.47323 8.86126 7.88526L9.95733 11.2586L7.08779 9.17376C6.7373 8.91912 6.2627 8.91912 5.91221 9.17376L3.04267 11.2586L4.13874 7.88525C4.27261 7.47323 4.12595 7.02186 3.77547 6.76722L0.905918 4.68237H4.45287C4.8861 4.68237 5.27006 4.40341 5.40393 3.99139L6.5 0.618034Z" stroke="#C7A992"/>
							</svg>
						</label>
						<input type="radio" id="star3" name="rating" value="3">
						<label for="star3" title="3 stars">
							<svg width="13" height="12" viewbox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M6.5 0.618034L7.59607 3.99139C7.72994 4.40341 8.1139 4.68237 8.54713 4.68237H12.0941L9.22453 6.76722C8.87405 7.02186 8.72739 7.47323 8.86126 7.88526L9.95733 11.2586L7.08779 9.17376C6.7373 8.91912 6.2627 8.91912 5.91221 9.17376L3.04267 11.2586L4.13874 7.88525C4.27261 7.47323 4.12595 7.02186 3.77547 6.76722L0.905918 4.68237H4.45287C4.8861 4.68237 5.27006 4.40341 5.40393 3.99139L6.5 0.618034Z" stroke="#C7A992"/>
							</svg>
						</label>
						<input type="radio" id="star2" name="rating" value="2">
						<label for="star2" title="2 stars">
							<svg width="13" height="12" viewbox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M6.5 0.618034L7.59607 3.99139C7.72994 4.40341 8.1139 4.68237 8.54713 4.68237H12.0941L9.22453 6.76722C8.87405 7.02186 8.72739 7.47323 8.86126 7.88526L9.95733 11.2586L7.08779 9.17376C6.7373 8.91912 6.2627 8.91912 5.91221 9.17376L3.04267 11.2586L4.13874 7.88525C4.27261 7.47323 4.12595 7.02186 3.77547 6.76722L0.905918 4.68237H4.45287C4.8861 4.68237 5.27006 4.40341 5.40393 3.99139L6.5 0.618034Z" stroke="#C7A992"/>
							</svg>
						</label>
						<input type="radio" id="star1" name="rating" value="1">
						<label for="star1" title="1 star">
							<svg width="13" height="12" viewbox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M6.5 0.618034L7.59607 3.99139C7.72994 4.40341 8.1139 4.68237 8.54713 4.68237H12.0941L9.22453 6.76722C8.87405 7.02186 8.72739 7.47323 8.86126 7.88526L9.95733 11.2586L7.08779 9.17376C6.7373 8.91912 6.2627 8.91912 5.91221 9.17376L3.04267 11.2586L4.13874 7.88525C4.27261 7.47323 4.12595 7.02186 3.77547 6.76722L0.905918 4.68237H4.45287C4.8861 4.68237 5.27006 4.40341 5.40393 3.99139L6.5 0.618034Z" stroke="#C7A992"/>
							</svg>
						</label>
					</div>

				</div>
				<div class="form-control">
					<input placeholder="Twoje imię *" type="text" id="name" name="name" required>
				</div>
				<div class="form-control">
					<textarea placeholder="Twoja opinia *" rows="3" id="opinion" name="text" required></textarea>
				</div>
				<div id="recaptcha"></div>
				<div class="button-container">
					<button type="submit" class="submit-button">
						<div>Wyślij</div><img src="image/catalog/assets/arrow_right.svg"/></button>
				</div>
				<div class="separator"></div>
			</form>
		</div>
	</div>

</div>
<div class="products-container-wrapper">
	<div class="header">
		<p class="title-mobile">Może Ci się spodobać również</p>
		<p class="title">
			Może Ci się spodobać również
		</p>

		<a href="/sklep">
			<div class="nav-to">
				<p>WSZYSTKO</p>
				<img src="image/catalog/assets/arrow_right.svg"/>
			</div>
		</a>
	</div>

	<div class="main">
		<div data-product-id="{{ id }}" id="products-container-related" class="products-container"></div>
	</div>
	<div class="related-carousel-pagination">
		<button id="related-prev" class="carousel-arrow prev"><img src="image/catalog/assets/arrow_left.svg"/></button>
		<button id="related-next" class="carousel-arrow next"><img src="image/catalog/assets/arrow_right.svg"/></button>
	</div>

</div>

{# Перед </body> — ваш скрипт #}
<script>
  var reviewCaptchaId;

  // После загрузки API рендерим виджет
  function onloadReviewCaptcha() {
    reviewCaptchaId = grecaptcha.render('recaptcha', {
      'sitekey': '6LcdvkYrAAAAAJn1VvFLQxAXRVvqLy1jqCQHbmc8'
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('review-form');
    const msg  = document.getElementById('review-message');

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      msg.textContent = '';

      // Получаем ответ капчи
      const token = grecaptcha.getResponse(reviewCaptchaId);
      if (!token) {
        msg.innerHTML = '<div class="alert alert-danger">Proszę potwierdzić, że nie jesteś robotem.</div>';
        return;
      }

      const data = new FormData(form);
      data.append('g-recaptcha-response', token);

      fetch(form.action, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
      .then(res => res.json())
      .then(json => {
        if (json.error) {
          msg.innerHTML = '<div class="alert alert-danger">'+json.error+'</div>';
        } else {
          msg.innerHTML = '<div class="alert alert-success">'+json.success+'</div>';
          form.reset();
          grecaptcha.reset(reviewCaptchaId);
          loadReviews();
        }
      })
      .catch(() => {
        msg.innerHTML = '<div class="alert alert-danger">Ошибка сети, попробуйте позже.</div>';
        grecaptcha.reset(reviewCaptchaId);
      });
    });

    // Загрузка и пагинация отзывов
    function loadReviews(page = 1) {
      const pid = form.querySelector('input[name="product_id"]').value;
      fetch(`index.php?route=product/product/review&product_id=${pid}&page=${page}`)
        .then(res => res.text())
        .then(html => {
          document.getElementById('reviews').innerHTML = html;
        });
    }
    loadReviews();
  });
</script>



{{footer}}
